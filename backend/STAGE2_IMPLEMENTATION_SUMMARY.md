# üìã –≠—Ç–∞–ø 2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö - –ó–∞–≤–µ—Ä—à–µ–Ω

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. StoreChatSource - –£–ª—É—á—à–µ–Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ `window.Store`
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä Store (Map, Array, Object)
- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ JID –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ wid, name, isGroup, unreadCount, avatarUrl
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ø—Ä–∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞

**–ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞ –∫ Chat models
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ ID (jid._serialized, jid.user, jid –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞)
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —á–∞—Ç–∞ –ø–æ JID (@g.us = group)
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (name, contact.name, pushName, formattedTitle)

### 2. CDPNetworkChatSource - –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è CDP —Å–µ—Å—Å–∏–∏
- ‚úÖ –í–∫–ª—é—á–µ–Ω–∏–µ Network domain
- ‚úÖ –ü–µ—Ä–µ—Ö–≤–∞—Ç network responses
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ JSON payloads
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —á–∞—Ç–æ–≤ –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –æ—Ç–≤–µ—Ç–æ–≤
- ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —á–∞—Ç–æ–≤ –ø–æ ID
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ cleanup

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ URL (chat, conversation, whatsapp)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –æ—Ç–≤–µ—Ç–æ–≤ (–º–∞—Å—Å–∏–≤—ã, –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã)
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ total count –∏–∑ payloads
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- Protobuf –ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω (—Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫)
- –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ WhatsApp Web –¥–µ–ª–∞–µ—Ç API –∑–∞–ø—Ä–æ—Å—ã –≤–æ –≤—Ä–µ–º—è –ø–∞—Ä—Å–∏–Ω–≥–∞

### 3. DOMChatSource - –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∏–∑ ChatParser
- ‚úÖ –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∏–∑ `ChatParser._parse_all_visible_chats`
- ‚úÖ –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–¥ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `IChatSource`
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤
- ‚úÖ –ú–µ—Ç–æ–¥ `scroll_for_more()` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —á–∞—Ç–æ–≤
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ seen_ids –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
- ‚úÖ –≠–≤—Ä–∏—Å—Ç–∏–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (reached_bottom + no_new_chats)

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç fallback ID –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ (data-id, data-chat-id, regex –∏–∑ aria-label)
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç fallback ID –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
- –í—Å–µ —á–∞—Ç—ã –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ integrity="fallback" (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞

### 4. SourceSelector - –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –≤—ã–±–æ—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–±–æ—Ä–∞
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
- ‚úÖ –ü—Ä–∏—á–∏–Ω—ã –≤—ã–±–æ—Ä–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

**–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∫–ª—é—á–∞—é—Ç:**
- –°–ø–∏—Å–æ–∫ –ø–æ–ø—ã—Ç–æ–∫ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
- –°—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–∏ (success/unavailable/error)
- –ü—Ä–∏—á–∏–Ω—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
- –û—à–∏–±–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã/—Å–æ–∑–¥–∞–Ω—ã:
- `store_chat_source.py` - —É–ª—É—á—à–µ–Ω–∞ (161 ‚Üí ~250 —Å—Ç—Ä–æ–∫)
- `cdp_network_chat_source.py` - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ (~80 ‚Üí ~250 —Å—Ç—Ä–æ–∫)
- `dom_chat_source.py` - —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ (~80 ‚Üí ~280 —Å—Ç—Ä–æ–∫)
- `source_selector.py` - —É–ª—É—á—à–µ–Ω–∞ (~75 ‚Üí ~150 —Å—Ç—Ä–æ–∫)

### –û–±—â–∏–π –æ–±—ä–µ–º –∫–æ–¥–∞:
- –î–æ–±–∞–≤–ª–µ–Ω–æ: ~500 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
- –£–ª—É—á—à–µ–Ω–æ: ~200 —Å—Ç—Ä–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞

## üîç –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### StoreChatSource
```python
# –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞
chatModels = store.Chat?.models || store.chats || store.Chat

# –ù–∞–¥–µ–∂–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ JID
jid = chat.id._serialized || chat.id.user || String(chat.id)

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞
isGroup = chat.isGroup || jid.endsWith('@g.us')
```

### CDPNetworkChatSource
```python
# –ü–µ—Ä–µ—Ö–≤–∞—Ç network responses
cdp_session.on('Network.responseReceived', handle_response)

# –ü–∞—Ä—Å–∏–Ω–≥ JSON payloads
# –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä (–º–∞—Å—Å–∏–≤—ã, –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã)
```

### DOMChatSource
```python
# Fallback ID –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ (—Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º)
chatId = data-id || data-chat-id || regex(aria-label) || generated

# –í—Å–µ —á–∞—Ç—ã –∏–º–µ—é—Ç integrity="fallback"
```

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **CDPNetworkChatSource:**
   - Protobuf –ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω (—Ç—Ä–µ–±—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ protobuf)
   - –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ WhatsApp –¥–µ–ª–∞–µ—Ç API –∑–∞–ø—Ä–æ—Å—ã –≤–æ –≤—Ä–µ–º—è –ø–∞—Ä—Å–∏–Ω–≥–∞
   - –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤

2. **DOMChatSource:**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç fallback –º–µ—Ç–æ–¥—ã –∏–∑–≤–ª–µ—á–µ–Ω–∏—è ID (–º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–Ω–æ)
   - –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã DOM (–º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ WhatsApp Web)
   - –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª–∏–Ω–≥ –º–æ–∂–µ—Ç –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —á–∞—Ç—ã

3. **StoreChatSource:**
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Store –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ WhatsApp Web
   - –¢—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ WhatsApp Web

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º –¥–∞–Ω–Ω—ã—Ö:
- ‚úÖ –í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Ä–µ–∞–ª–∏–∑—É—é—Ç `IChatSource`
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `init()`, `fetch_batch()`, `is_complete()`, `total_expected()`
- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —á–µ—Ä–µ–∑ `SourceSelector`
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:
- ‚úÖ Store: ID –∏–∑ jid/wid (–Ω–∞–¥–µ–∂–Ω–æ)
- ‚úÖ Network: ID –∏–∑ jid/server_id/user_id (–Ω–∞–¥–µ–∂–Ω–æ)
- ‚úÖ DOM: Fallback –º–µ—Ç–æ–¥—ã (–º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–Ω–æ, –Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–æ –¥–ª—è fallback)
- ‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å aria-label –¥–ª—è ID –≤ Store/Network (—Ç–æ–ª—å–∫–æ –≤ DOM –∫–∞–∫ fallback)

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ–ª–Ω–æ—Ç–µ:
- ‚úÖ Store: `total_expected()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç count –∏–∑ Store
- ‚úÖ Network: `total_expected()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç count –∏–∑ payloads (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
- ‚úÖ DOM: `total_expected()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None (–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ)
- ‚úÖ `is_complete()` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –¥–ª—è –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–≠—Ç–∞–ø 3)

1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `ChatNormalizer` - –ø–æ–ª–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `IdentityResolver` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è ID
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `CompletionController` - –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏
4. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `ResultPublisher` - –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
5. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `ChatParsingOrchestrator` - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
- SourceSelector –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –≠—Ç–∞–ø 2 —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω


