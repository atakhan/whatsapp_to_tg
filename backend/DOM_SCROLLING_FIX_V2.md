# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞ DOM –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (v2)

## –ü—Ä–æ–±–ª–µ–º–∞

DOM –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–∞–≥—Ä—É–∂–∞–ª —Ç–æ–ª—å–∫–æ 66 —á–∞—Ç–æ–≤ –∏–∑ –±–æ–ª–µ–µ —á–µ–º 100, –ø–æ—Ç–æ–º—É —á—Ç–æ:
1. –°–∫—Ä–æ–ª–ª–∏–Ω–≥ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª –Ω–æ–≤—ã–µ —á–∞—Ç—ã –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –±–∞—Ç—á–∞
2. –õ–æ–≥–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±—ã–ª–∞ —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π (–∑–∞–≤–µ—Ä—à–∞–ª–∞—Å—å –ø–æ—Å–ª–µ 3 –∏—Ç–µ—Ä–∞—Ü–∏–π)
3. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ "–¥–æ—Å—Ç–∏–≥–ª–∏ –¥–Ω–∞" –±—ã–ª–æ —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–Ω–∏–º

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞

**–§–∞–π–ª:** `backend/app/services/whatsapp/parsing/sources/dom_chat_source.py`

- **–£–≤–µ–ª–∏—á–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞**: —Å 3 –¥–æ 5 –ø–æ–ø—ã—Ç–æ–∫ –Ω–∞ –±–∞—Ç—á
- **–£–≤–µ–ª–∏—á–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è**: —Å 1.0 –¥–æ 1.2 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
- **–£–ª—É—á—à–µ–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞**:
  - –ï—Å–ª–∏ –¥–∞–ª–µ–∫–æ –æ—Ç –Ω–∏–∑–∞ (> 1000px) ‚Üí —Å–∫—Ä–æ–ª–ª–∏—Ç –Ω–∞ 150% viewport –∏–ª–∏ –º–∏–Ω–∏–º—É–º 1000px
  - –ï—Å–ª–∏ –±–ª–∏–∑–∫–æ –∫ –Ω–∏–∑—É (< 1000px) ‚Üí —Å–∫—Ä–æ–ª–ª–∏—Ç –¥–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ–≥–æ –Ω–∏–∑–∞ —Å–ø–∏—Å–∫–∞
  - –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –≤—Å–µ—Ö —á–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª–∏–Ω–≥

### 2. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–Ω–∞

**–§–∞–π–ª:** `backend/app/services/whatsapp/parsing/sources/dom_chat_source.py`

- **–ë–æ–ª–µ–µ –ª–µ–Ω–∏–≤–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: —Ç–µ–ø–µ—Ä—å —Å—á–∏—Ç–∞–µ—Ç "–¥–Ω–æ" –µ—Å–ª–∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 200px (–±—ã–ª–æ 100px)
- **–°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –ø—Ä–∏ –Ω–æ–≤—ã—Ö —á–∞—Ç–∞—Ö**: –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –Ω–æ–≤—ã–µ —á–∞—Ç—ã –ø–æ—Å–ª–µ "–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–Ω–∞", —Ñ–ª–∞–≥ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è
- –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ

### 3. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

**–§–∞–π–ª:** `backend/app/services/whatsapp/parsing/sources/dom_chat_source.py`

- **–£–≤–µ–ª–∏—á–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π –±–µ–∑ –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤**:
  - –î–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–Ω–∞: —Å 3 –¥–æ 5 –∏—Ç–µ—Ä–∞—Ü–∏–π
  - –û–±—â–∏–π –ª–∏–º–∏—Ç: —Å 5 –¥–æ 10 –∏—Ç–µ—Ä–∞—Ü–∏–π
- **–£–≤–µ–ª–∏—á–µ–Ω –ª–∏–º–∏—Ç —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞**: —Å 50 –¥–æ 100 –∏—Ç–µ—Ä–∞—Ü–∏–π (–∑–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞)

### 4. –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–∞—Ç–æ–≤

**–§–∞–π–ª:** `backend/app/services/whatsapp/parsing/sources/dom_chat_source.py`

- –î–æ–±–∞–≤–ª–µ–Ω–æ –±–æ–ª—å—à–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–∞—Ç–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º–æ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
- –£–ª—É—á—à–µ–Ω fallback –Ω–∞ window scroll

### 5. –£–ª—É—á—à–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

**–§–∞–π–ª:** `backend/app/services/whatsapp/parsing/sources/dom_chat_source.py`

- –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∫—Ä–æ–ª–ª–∏—Ç –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —á–∞—Ç–æ–≤ –≤ –Ω–∞—á–∞–ª–æ
- –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –º—ã –Ω–∞—á–∏–Ω–∞–µ–º —Å –Ω–∞—á–∞–ª–∞ —Å–ø–∏—Å–∫–∞

## –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

–ü–æ—Å–ª–µ —ç—Ç–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
1. ‚úÖ DOM –∏—Å—Ç–æ—á–Ω–∏–∫ –±—É–¥–µ—Ç —Å–∫—Ä–æ–ª–ª–∏—Ç—å –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ (5 –ø–æ–ø—ã—Ç–æ–∫ –Ω–∞ –±–∞—Ç—á)
2. ‚úÖ –ë—É–¥–µ—Ç —Å–∫—Ä–æ–ª–ª–∏—Ç—å –¥–æ —Å–∞–º–æ–≥–æ –Ω–∏–∑–∞ —Å–ø–∏—Å–∫–∞, –µ—Å–ª–∏ –±–ª–∏–∑–∫–æ –∫ –Ω–∏–∑—É
3. ‚úÖ –ë—É–¥–µ—Ç –∂–¥–∞—Ç—å –¥–æ–ª—å—à–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ (1.2 —Å–µ–∫—É–Ω–¥—ã)
4. ‚úÖ –ù–µ –±—É–¥–µ—Ç –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è (10 –∏—Ç–µ—Ä–∞—Ü–∏–π –±–µ–∑ –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤)
5. ‚úÖ –ë—É–¥–µ—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å —Ñ–ª–∞–≥ "–¥–æ—Å—Ç–∏–≥–ª–∏ –¥–Ω–∞", –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –Ω–æ–≤—ã–µ —á–∞—Ç—ã

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å DOM –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∂–∞—Ç—å **–≤—Å–µ** —á–∞—Ç—ã, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 66. –ï—Å–ª–∏ —É –≤–∞—Å –±–æ–ª–µ–µ 100 —á–∞—Ç–æ–≤, –æ–Ω–∏ –≤—Å–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏—Ç–µ—Ä–∞—Ü–∏–π —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞.

## –õ–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

–í –ª–æ–≥–∞—Ö –≤—ã —É–≤–∏–¥–∏—Ç–µ:
- `"DOM scroll: iteration=X, scrollTop=..., scrollHeight=..., scrollDelta=..., atBottom=..., hasMoreContent=..."`
- `"DOM source: parsed X chats (Y new, Z total seen, no_new_count=...)"`
- `"DOM source: found new chats after reaching bottom, resetting bottom flag"` (–µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –Ω–æ–≤—ã–µ —á–∞—Ç—ã –ø–æ—Å–ª–µ "–¥–Ω–∞")

–ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –≤—Å–µ —á–∞—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞
- –ó–Ω–∞—á–µ–Ω–∏–µ `scrollHeight` - —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –ª–∏ –æ–Ω–æ
- –ó–Ω–∞—á–µ–Ω–∏–µ `hasMoreContent` - –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ª–∏ –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç

