# üîß –£–ª—É—á—à–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞ DOM –∏—Å—Ç–æ—á–Ω–∏–∫–∞

## –ü—Ä–æ–±–ª–µ–º–∞

DOM –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–∞–≥—Ä—É–∂–∞–ª —Ç–æ–ª—å–∫–æ 66 —á–∞—Ç–æ–≤ –∏–∑ –±–æ–ª–µ–µ —á–µ–º 100, –ø–æ—Ç–æ–º—É —á—Ç–æ:
1. WhatsApp Web –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª–∏–Ω–≥ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —á–∞—Ç—ã
2. DOM –∏—Å—Ç–æ—á–Ω–∏–∫ –ø–∞—Ä—Å–∏–ª —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —á–∞—Ç—ã –±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
3. –õ–æ–≥–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±—ã–ª–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞–¥–µ–∂–Ω–æ–π

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–æ–ª–ª–∏–Ω–≥ –≤ fetch_batch

**–§–∞–π–ª:** `backend/app/services/whatsapp/parsing/sources/dom_chat_source.py`

- –î–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–æ–ª–ª–∏–Ω–≥ –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º –∫–∞–∂–¥–æ–≥–æ –±–∞—Ç—á–∞
- –°–∫—Ä–æ–ª–ª–∏–Ω–≥ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
  - –ù–µ –¥–æ—Å—Ç–∏–≥–ª–∏ –¥–Ω–∞ —Å–ø–∏—Å–∫–∞ (`_reached_bottom == False`)
  - –ù–∞–π–¥–µ–Ω—ã –Ω–æ–≤—ã–µ —á–∞—Ç—ã –Ω–µ–¥–∞–≤–Ω–æ (`_no_new_chats_count < 5`)
- –£–≤–µ–ª–∏—á–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ—Å–ª–µ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞ –¥–æ 0.8 —Å–µ–∫—É–Ω–¥ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞

### 2. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞

**–§–∞–π–ª:** `backend/app/services/whatsapp/parsing/sources/dom_chat_source.py`

- –£–ª—É—á—à–µ–Ω –º–µ—Ç–æ–¥ `scroll_for_more()`:
  - –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –Ω–∞ 80% –≤—ã—Å–æ—Ç—ã viewport (–≤–º–µ—Å—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö 500px)
  - –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤
  - –õ—É—á—à–µ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–Ω–∞ (50px –æ—Ç—Å—Ç—É–ø)
  - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### 3. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

**–§–∞–π–ª:** `backend/app/services/whatsapp/parsing/sources/dom_chat_source.py`

–ú–µ—Ç–æ–¥ `is_complete()` —Ç–µ–ø–µ—Ä—å –∑–∞–≤–µ—Ä—à–∞–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥ –µ—Å–ª–∏:
1. –î–æ—Å—Ç–∏–≥–ª–∏ –¥–Ω–∞ –ò –Ω–µ—Ç –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤ 3 –∏—Ç–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥—Ä—è–¥
2. –ù–µ—Ç –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤ 5 –∏—Ç–µ—Ä–∞—Ü–∏–π –ø–æ–¥—Ä—è–¥ (–¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –¥–æ—Å—Ç–∏–≥–ª–∏ –¥–Ω–∞ - –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞—Å—Ç—Ä—è–ª–∏)
3. –î–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞ (50 –∏—Ç–µ—Ä–∞—Ü–∏–π) - –∑–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞

### 4. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ orchestrator

**–§–∞–π–ª:** `backend/app/services/whatsapp/parsing/orchestrator.py`

- Orchestrator —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å `fetch_batch()` –¥–∞–∂–µ –µ—Å–ª–∏ –±–∞—Ç—á –ø—É—Å—Ç–æ–π
- –î–ª—è DOM –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—É—Å—Ç–æ–π –±–∞—Ç—á –Ω–µ –æ–∑–Ω–∞—á–∞–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ - –Ω—É–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å–∫—Ä–æ–ª–ª–∏—Ç—å
- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ —è–≤–Ω–æ —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç `is_complete() == True`

### 5. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤

**–§–∞–π–ª:** `backend/app/services/whatsapp/parsing/sources/dom_chat_source.py`

- –î–æ–±–∞–≤–ª–µ–Ω —Å—á–µ—Ç—á–∏–∫ `_no_new_chats_count` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Ç–µ—Ä–∞—Ü–∏–π –±–µ–∑ –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤
- –°—á–µ—Ç—á–∏–∫ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞

## –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

–ü–æ—Å–ª–µ —ç—Ç–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
1. ‚úÖ DOM –∏—Å—Ç–æ—á–Ω–∏–∫ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
2. ‚úÖ –ë—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –≤—Å–µ —á–∞—Ç—ã, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ
3. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞
4. ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ (–ª–∏–º–∏—Ç 50 –∏—Ç–µ—Ä–∞—Ü–∏–π)

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å DOM –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∂–∞—Ç—å **–≤—Å–µ** —á–∞—Ç—ã, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ. –ï—Å–ª–∏ —É –≤–∞—Å –±–æ–ª–µ–µ 100 —á–∞—Ç–æ–≤, –æ–Ω–∏ –≤—Å–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω—ã.

## –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ

–ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –≤—Å–µ —á–∞—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –¥–Ω–∞ –∏–ª–∏ –ª–∏–º–∏—Ç–∞ –∏—Ç–µ—Ä–∞—Ü–∏–π
- –í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ—Å–ª–µ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞
- –í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–∞—Ç–æ–≤

