# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è ID –∏–∑ DOM –∏—Å—Ç–æ—á–Ω–∏–∫–∞

## –ü—Ä–æ–±–ª–µ–º–∞

DOM –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–∞—Ö–æ–¥–∏–ª 66 —á–∞—Ç–æ–≤, –Ω–æ –≤—Å–µ –æ–Ω–∏ –Ω–µ –º–æ–≥–ª–∏ –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã, –ø–æ—Ç–æ–º—É —á—Ç–æ —É –Ω–∏—Ö –Ω–µ –±—ã–ª–æ ID:
- "No reliable ID found for chat: name=..., source=dom, candidates=[]"
- "Cannot normalize chat without ID"

## –ü—Ä–∏—á–∏–Ω–∞

1. DOM –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–∑–≤–ª–µ–∫–∞–ª `chatId` –∏–∑ DOM, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–ª –µ–≥–æ —Ç–æ–ª—å–∫–æ –≤ `jid` –µ—Å–ª–∏ –æ–Ω —Å–æ–¥–µ—Ä–∂–∞–ª '@'
2. –ï—Å–ª–∏ ID –Ω–µ –±—ã–ª JID —Ñ–æ—Ä–º–∞—Ç–∞, –æ–Ω –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è –Ω–∏ –≤ –æ–¥–Ω–æ –ø–æ–ª–µ
3. `IdentityResolver` –∏—Å–∫–∞–ª ID —Ç–æ–ª—å–∫–æ –≤ `jid`, `wid`, `server_id`, `user_id`
4. –†–µ–∑—É–ª—å—Ç–∞—Ç: —á–∞—Ç—ã –±–µ–∑ ID –Ω–µ –º–æ–≥–ª–∏ –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –£–ª—É—á—à–µ–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ ID –∏–∑ DOM

**–§–∞–π–ª:** `backend/app/services/whatsapp/parsing/sources/dom_chat_source.py`

–î–æ–±–∞–≤–ª–µ–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –∏–∑–≤–ª–µ—á–µ–Ω–∏—è ID:
- –ü–æ–∏—Å–∫ –≤ `data-testid` –∞—Ç—Ä–∏–±—É—Ç–µ
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ —Å—Å—ã–ª–æ–∫ (`href`) - –Ω–∞–ø—Ä–∏–º–µ—Ä `/chat/1234567890@c.us`
- –ü–æ–∏—Å–∫ ID –≤ –¥–æ—á–µ—Ä–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö
- –£–ª—É—á—à–µ–Ω regex –¥–ª—è –ø–æ–∏—Å–∫–∞ JID –≤ aria-label
- –°—Ç–∞–±–∏–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è fallback ID –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö–µ—à–∞ –∏–º–µ–Ω–∏ –∏ –∏–Ω–¥–µ–∫—Å–∞

### 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ fallback ID

**–§–∞–π–ª:** `backend/app/services/whatsapp/parsing/sources/dom_chat_source.py`

–¢–µ–ø–µ—Ä—å DOM –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç ID –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
- –ï—Å–ª–∏ ID –ø–æ—Ö–æ–∂ –Ω–∞ JID (—Å–æ–¥–µ—Ä–∂–∏—Ç '@') ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `jid`
- –ï—Å–ª–∏ ID –Ω–µ JID ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `wid` (–∫–∞–∫ fallback ID)
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç `IdentityResolver` –Ω–∞–π—Ç–∏ ID –¥–∞–∂–µ –¥–ª—è fallback —Å–ª—É—á–∞–µ–≤

### 3. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ fallback ID –≤ IdentityResolver

**–§–∞–π–ª:** `backend/app/services/whatsapp/parsing/identity/identity_resolver.py`

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ fallback ID –æ—Ç DOM –∏—Å—Ç–æ—á–Ω–∏–∫–∞:
- `IdentityResolver` —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `wid` –æ—Ç DOM –∏—Å—Ç–æ—á–Ω–∏–∫–∞
- Fallback ID (–Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å `dom_chat_`) —Å—á–∏—Ç–∞—é—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–ª—è DOM –∏—Å—Ç–æ—á–Ω–∏–∫–∞
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å DOM –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω:
1. ‚úÖ –õ—É—á—à–µ –∏–∑–≤–ª–µ–∫–∞—Ç—å ID –∏–∑ DOM (–±–æ–ª—å—à–µ —Å–ø–æ—Å–æ–±–æ–≤ –ø–æ–∏—Å–∫–∞)
2. ‚úÖ –°–æ—Ö—Ä–∞–Ω—è—Ç—å fallback ID –≤ –ø–æ–ª–µ `wid`
3. ‚úÖ –ü–æ–∑–≤–æ–ª—è—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å —á–∞—Ç—ã –¥–∞–∂–µ —Å fallback ID
4. ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ fallback ID –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–º–µ–Ω–∏ –∏ –ø–æ–∑–∏—Ü–∏–∏

## –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

–ü–æ—Å–ª–µ —ç—Ç–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- DOM –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–∞–π–¥–µ—Ç —á–∞—Ç—ã
- –ò–∑–≤–ª–µ—á–µ—Ç ID (–∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç fallback ID)
- –°–æ—Ö—Ä–∞–Ω–∏—Ç ID –≤ `wid` –ø–æ–ª–µ
- `IdentityResolver` –Ω–∞–π–¥–µ—Ç ID –≤ `wid`
- –ß–∞—Ç—ã –±—É–¥—É—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ `ChatDTO`
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª—É—á–∏—Ç —á–∞—Ç—ã —Å ID

## –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ

Fallback ID (`dom_chat_...`) –º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–Ω—ã, —á–µ–º JID –∏–∑ Store, –Ω–æ –æ–Ω–∏:
- –°—Ç–∞–±–∏–ª—å–Ω—ã (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö–µ—à–∞ –∏–º–µ–Ω–∏)
- –£–Ω–∏–∫–∞–ª—å–Ω—ã (–≤–∫–ª—é—á–∞—é—Ç –∏–Ω–¥–µ–∫—Å)
- –ü–æ–∑–≤–æ–ª—è—é—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å —á–∞—Ç—ã –∏–∑ DOM –∏—Å—Ç–æ—á–Ω–∏–∫–∞
- –û—Ç–º–µ—á–µ–Ω—ã –∫–∞–∫ `integrity="fallback"` –≤ `ChatDTO`

