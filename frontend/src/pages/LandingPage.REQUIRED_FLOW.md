# Требуемый User Flow: Миграция чатов WhatsApp → Telegram

**Текущий статус:** Требуется рефакторинг для соответствия требованиям

---

## 🎯 Правильный User Flow (по требованиям)

### 📍 **Этап 1: Landing (Начальный экран)**

```
┌─────────────────────────────────────┐
│  [TETRAKOM] Миграция чатов          │
│                                     │
│  ┌──────────┐      ┌──────────┐    │
│  │ WhatsApp │      │ Telegram │    │
│  │  🔒      │      │  🔒      │    │
│  │ Планета  │      │ Планета  │    │
│  └──────────┘      └──────────┘    │
│  Статус:          Статус:           │
│  Не подключено    Не подключено     │
│  (полупрозрачно)  (полупрозрачно)   │
└─────────────────────────────────────┘
```

**Требования:**
- ✅ Две планеты отображаются одновременно (split-screen)
- ❌ **НЕТ кнопки "Запустить перенос"** - пользователь сразу видит планеты
- ❌ **Замок (🔒) в центре планеты** - если не авторизован
- ❌ **Статус под планетой** - полупрозрачный текст с текущим статусом
- ✅ Статусы отслеживаются и обновляются

**Состояния планет:**
- `waStatus`: 'idle' | 'loading' | 'qr' | 'connecting' | 'connected'
- `tgPhase`: 'hidden' | 'entering' | 'phone' | 'code' | 'password' | 'connected'
- Замок показывается, если статус !== 'connected'

**Текущая реализация:**
- ❌ Есть кнопка "Запустить перенос"
- ❌ Планеты центрируются после клика
- ❌ Нет замков на планетах
- ❌ Нет статусов под планетами

---

### 📍 **Этап 2: Подключение мессенджеров**

```
┌─────────────────────────────────────┐
│  ┌──────────┐      ┌──────────┐     │
│  │ WhatsApp │      │ Telegram │     │
│  │  🔒      │      │  🔒      │     │
│  │ Планета  │      │ Планета  │     │
│  └──────────┘      └──────────┘     │
│  Статус:          Статус:            │
│  Подключение...   Нажмите для        │
│                   авторизации        │
└─────────────────────────────────────┘
```

**Требования:**
- ✅ **Параллельное подключение** - можно подключать оба мессенджера независимо
- ✅ Планеты остаются на своих местах (не центрируются)
- ✅ Клик на планету → показывается overlay с формой подключения
- ✅ После подключения замок исчезает
- ✅ Статус обновляется под планетой

**Процесс подключения WhatsApp:**
1. Клик на WhatsApp планету
2. Overlay с кнопкой "Подключиться" (если idle)
3. Проверка/создание сессии
4. Показ QR-кода (если нужен)
5. Ожидание сканирования
6. Статус: "Подключено" → замок исчезает

**Процесс подключения Telegram:**
1. Клик на Telegram планету
2. Overlay с кнопкой "Авторизоваться"
3. Ввод телефона
4. Ввод кода
5. Ввод пароля (если 2FA)
6. Статус: "Авторизовано" → замок исчезает

**Текущая реализация:**
- ❌ Последовательное подключение (сначала WhatsApp, потом Telegram)
- ❌ Планеты центрируются при подключении
- ❌ Нет замков
- ❌ Нет статусов под планетами

---

### 📍 **Этап 3: Выбор чатов**

```
┌─────────────────────────────────────┐
│  ┌──────────┐      ┌──────────┐     │
│  │ WhatsApp │      │ Telegram │     │
│  │  ✅      │      │  ✅      │     │
│  │ Планета  │      │ Планета  │     │
│  └──────────┘      └──────────┘     │
│  Статус:          Статус:            │
│  Подключено       Авторизовано        │
│                                     │
│  [Анимация загрузки чатов...]       │
│                                     │
│  ⭕ ⭕ ⭕ ⭕      ⭕ ⭕ ⭕ ⭕     │
│  (WhatsApp чаты)  (Telegram чаты)   │
│                                     │
│  Выберите чат:    Выберите или      │
│  WhatsApp         создайте чат:     │
│                   Telegram          │
└─────────────────────────────────────┘
```

**Требования:**
- ✅ **Параллельный выбор** - можно выбирать чаты в обоих мессенджерах одновременно
- ✅ **Анимация загрузки чатов** - визуальная индикация процесса
- ✅ WhatsApp: выбор существующего чата
- ✅ Telegram: выбор существующего чата ИЛИ создание новой группы
- ✅ Чаты отображаются в орбитальных кольцах вокруг планет
- ✅ Планеты остаются на своих местах

**Процесс:**
1. После подключения автоматически загружаются чаты
2. Показывается анимация загрузки
3. Чаты появляются в орбитальных кольцах
4. Пользователь выбирает WhatsApp чат
5. Пользователь выбирает или создает Telegram чат/группу

**Текущая реализация:**
- ✅ Загрузка чатов есть
- ✅ Орбитальное расположение есть
- ❌ Последовательный выбор (сначала WhatsApp, потом Telegram)
- ❌ Нет создания новой группы в Telegram
- ❌ Планеты перемещаются при выборе

---

### 📍 **Этап 4: Просмотр и выбор сообщений для переноса**

```
┌─────────────────────────────────────┐
│  ┌──────────┐      ┌──────────┐     │
│  │ WhatsApp │      │ Telegram │     │
│  │  ✅      │      │  ✅      │     │
│  └──────────┘      └──────────┘     │
│                                     │
│  ┌─────────────────────────────┐   │
│  │ WhatsApp: Название чата      │   │
│  │ Telegram: Название чата      │   │
│  ├─────────────────────────────┤   │
│  │ [Фильтр сообщений]           │   │
│  │ ┌─────────────────────────┐ │   │
│  │ │ ☑ Сообщение 1          │ │   │
│  │ │ ☑ Сообщение 2          │ │   │
│  │ │ ☐ Сообщение 3          │ │   │
│  │ │ ...                    │ │   │
│  │ └─────────────────────────┘ │   │
│  │ [Загрузить еще] [Загрузить  │   │
│  │  все сообщения]              │   │
│  └─────────────────────────────┘   │
│                                     │
│  Выбрано: 2 сообщения              │
│  [Начать перенос]                  │
└─────────────────────────────────────┘
```

**Требования:**
- ✅ **Начальная загрузка: последние 3 сообщения**
- ✅ **Фильтрация сообщений** - возможность фильтровать по типу, дате, отправителю
- ✅ **Управление подгрузкой:**
  - "Загрузить еще сообщение" - подгружает следующее сообщение
  - "Загрузить все сообщения" - подгружает все оставшиеся
- ✅ **Выбор сообщений** - чекбоксы для выбора конкретных сообщений
- ✅ **Счетчик выбранных** - показывает количество выбранных сообщений
- ✅ **Кнопка "Начать перенос"** - появляется когда выбрано хотя бы одно сообщение
- ✅ Планеты остаются видимыми (не скрываются)

**Процесс:**
1. После выбора чатов показывается область с сообщениями
2. Загружаются последние 3 сообщения
3. Пользователь может:
   - Фильтровать сообщения
   - Выбирать сообщения (чекбоксы)
   - Загружать еще сообщения
   - Загружать все сообщения
4. Когда выбрано хотя бы одно сообщение → появляется кнопка "Начать перенос"

**Текущая реализация:**
- ❌ Загружаются последние 5 сообщений (не 3)
- ❌ Нет фильтрации сообщений
- ❌ Нет выбора конкретных сообщений (загружаются все)
- ❌ Нет управления подгрузкой
- ❌ Планеты скрываются/перемещаются при просмотре сообщений
- ❌ Нет счетчика выбранных сообщений

---

### 📍 **Этап 5: Перенос и анимация переноса**

```
┌─────────────────────────────────────┐
│                                     │
│         ⭕ Loading Circle            │
│         Перенос в процессе...       │
│                                     │
│  ┌─────────────────────────────┐   │
│  │ [Фоновая лента логов]        │   │
│  │ 12:34:56 INFO Загрузка...   │   │
│  │ 12:34:57 INFO Перенос...     │   │
│  │ 12:34:58 WARN Предупреждение│   │
│  │ ...                          │   │
│  └─────────────────────────────┘   │
│                                     │
└─────────────────────────────────────┘
```

**Требования:**
- ✅ **Loading circle** - анимированный круг посередине экрана
- ✅ **Фоновая лента логов** - дизайн-элемент с настоящими логами
- ✅ Логи показывают реальный прогресс переноса
- ✅ Анимация продолжается до завершения переноса

**Процесс:**
1. Клик на "Начать перенос"
2. Показывается loading circle
3. Начинается перенос сообщений
4. Логи обновляются в реальном времени
5. Показывается прогресс

**Текущая реализация:**
- ❌ Нет этапа переноса (TODO в коде)
- ❌ Нет loading circle
- ✅ Есть фоновая лента логов (но используется только для загрузки сообщений)

---

### 📍 **Этап 6: Завершение переноса**

```
┌─────────────────────────────────────┐
│                                     │
│  ✅ Перенос завершен!               │
│                                     │
│  Перенесено: 15 сообщений          │
│  Из WhatsApp: Название чата         │
│  В Telegram: Название чата         │
│                                     │
│  [Выбрать другой чат]              │
│  [Завершить сессию]                 │
└─────────────────────────────────────┘
```

**Требования:**
- ✅ **Сообщение об итогах** - количество перенесенных сообщений
- ✅ **Информация о чатах** - откуда и куда перенесено
- ✅ **Кнопка "Выбрать другой чат"** - возврат к этапу 3
- ✅ **Кнопка "Завершить сессию"** - выход из процесса

**Процесс:**
1. После завершения переноса показывается экран результатов
2. Пользователь видит статистику
3. Может выбрать другой чат для переноса
4. Или завершить сессию

**Текущая реализация:**
- ❌ Нет экрана завершения
- ❌ Нет статистики переноса
- ❌ Нет возможности выбрать другой чат

---

## 🔄 Сравнение: Текущий vs Требуемый Flow

| Этап | Текущий Flow | Требуемый Flow | Статус |
|------|--------------|----------------|--------|
| **Landing** | Кнопка "Запустить перенос" | Планеты с замками и статусами | ❌ Требуется изменение |
| **Подключение** | Последовательно (WA → TG) | Параллельно (оба независимо) | ❌ Требуется изменение |
| **Выбор чатов** | Последовательно (WA → TG) | Параллельно (оба одновременно) | ❌ Требуется изменение |
| **Сообщения** | Просмотр всех (5 шт) | Выбор конкретных (3 начальных) | ❌ Требуется изменение |
| **Фильтрация** | Нет | Есть | ❌ Требуется добавление |
| **Подгрузка** | Нет | Есть (еще/все) | ❌ Требуется добавление |
| **Перенос** | TODO | С анимацией и логами | ❌ Требуется реализация |
| **Завершение** | Нет | Экран результатов | ❌ Требуется добавление |

---

## 🛠️ Что нужно изменить

### 1. **Landing (Этап 1)**
- ❌ Убрать кнопку "Запустить перенос"
- ❌ Убрать анимацию скрытия элементов
- ✅ Добавить замки на планеты (если не авторизован)
- ✅ Добавить статусы под планетами (полупрозрачные)
- ✅ Планеты остаются на своих местах

### 2. **Подключение (Этап 2)**
- ❌ Убрать центрирование планет
- ❌ Убрать последовательность (WA → TG)
- ✅ Параллельное подключение
- ✅ Overlay при клике на планету
- ✅ Замок исчезает после подключения

### 3. **Выбор чатов (Этап 3)**
- ❌ Убрать последовательность
- ✅ Параллельный выбор
- ✅ Анимация загрузки чатов
- ✅ Возможность создания группы в Telegram
- ✅ Планеты остаются на местах

### 4. **Сообщения (Этап 4)**
- ❌ Изменить начальную загрузку: 5 → 3 сообщения
- ✅ Добавить фильтрацию сообщений
- ✅ Добавить выбор сообщений (чекбоксы)
- ✅ Добавить управление подгрузкой
- ✅ Добавить счетчик выбранных
- ✅ Кнопка "Начать перенос" появляется при выборе

### 5. **Перенос (Этап 5)**
- ❌ Реализовать процесс переноса
- ✅ Добавить loading circle
- ✅ Использовать фоновую ленту логов для реальных логов переноса

### 6. **Завершение (Этап 6)**
- ❌ Добавить экран результатов
- ✅ Статистика переноса
- ✅ Кнопки "Выбрать другой чат" и "Завершить сессию"

---

## 📋 Чеклист изменений

### Критичные изменения (блокируют правильный flow):
- [ ] Убрать кнопку "Запустить перенос"
- [ ] Убрать анимацию скрытия элементов (hideStage)
- [ ] Убрать центрирование планет
- [ ] Добавить замки на планеты
- [ ] Добавить статусы под планетами
- [ ] Изменить на параллельное подключение
- [ ] Изменить на параллельный выбор чатов
- [ ] Добавить выбор сообщений (чекбоксы)
- [ ] Изменить начальную загрузку: 5 → 3 сообщения
- [ ] Добавить фильтрацию сообщений
- [ ] Добавить управление подгрузкой сообщений
- [ ] Реализовать процесс переноса
- [ ] Добавить loading circle для переноса
- [ ] Добавить экран завершения

### Улучшения:
- [ ] Возможность создания группы в Telegram
- [ ] Улучшенная анимация загрузки чатов
- [ ] Счетчик выбранных сообщений
- [ ] Статистика переноса

---

*Документ создан на основе требований пользователя*

