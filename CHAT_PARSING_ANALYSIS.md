# Анализ процесса парсинга чатов из WhatsApp Web

## Обзор

Парсинг чатов происходит через Playwright, который управляет браузером и выполняет JavaScript код для извлечения данных из DOM WhatsApp Web.

## Основной процесс

### 1. Поиск контейнера списка чатов

**Метод:** `parse_chats_streaming()` в `chat_parser.py`

**Селекторы контейнера (в порядке приоритета):**
```javascript
'div[data-testid="chatlist"]'        // Основной контейнер списка чатов
'div[role="listbox"]'                // ARIA-роль списка
'div[aria-label*="Chat"]'            // Контейнер с aria-label содержащим "Chat"
'div#app > div > div > div[role="application"] > div > div'  // Глубокая структура
'div[data-testid="chat"]'            // Альтернативный селектор
```

**Логика:**
- Пробуем каждый селектор по очереди
- Ждем появления элемента (timeout 5 секунд)
- Используем первый найденный

### 2. Поиск элементов чатов

**Метод:** `_parse_all_visible_chats()` 

**Селекторы элементов чатов (в порядке приоритета):**
```javascript
'div[data-testid="cell-frame-container"]'  // Основной контейнер ячейки чата
'div[role="row"]'                           // Строка в списке
'div[data-testid="chat"]'                   // Прямой селектор чата
'div[aria-label*="Chat"]'                   // По aria-label
'div[aria-label*="чат"]'                    // Русская локализация
'div[aria-label*="групп"]'                 // Группы (рус.)
'div[aria-label*="group"]'                 // Группы (англ.)
'div[role="listbox"] > div'                // Дочерние элементы списка
'div[data-testid="list"] > div'            // Альтернативный список
```

**Особенность:** Пробуем все селекторы и выбираем тот, который находит больше всего элементов.

### 3. Извлечение данных чата

Для каждого найденного элемента чата извлекаем:

#### Имя чата (name)
**Приоритет источников:**
1. `aria-label` атрибут - берем первую часть до запятой: `/^([^,]+)/`
2. Элемент с `[title]` атрибутом
3. `textContent` элемента (первые 100 символов, первая строка)
4. Fallback: `Chat ${index + 1}`

#### ID чата (id)
**Приоритет источников:**
1. Из `aria-label` - регулярное выражение: `/(\+?\d{10,15}|\d+@[cg]\.us)/`
   - Телефонный номер: `+1234567890` или `1234567890`
   - WhatsApp ID: `1234567890@c.us` (личный) или `1234567890@g.us` (группа)
2. Атрибуты элемента:
   - `data-id`
   - `data-chat-id`
   - `id`
3. Fallback: `chat_${index}_${sanitized_name}`

#### Тип чата (is_group)
**Определение:**
- Наличие `[data-testid="group"]` или `[data-testid="group-icon"]`
- `aria-label` содержит "group" или "групп"
- По умолчанию: `false` (личный чат)

#### Аватар (avatar)
- Ищем `img[src]` внутри элемента
- Берем атрибут `src`

#### Количество непрочитанных (message_count)
- Ищем `[data-testid="icon-unread-count"]`
- Парсим текст как число

### 4. Прокрутка и виртуальный скроллинг

**Проблема:** WhatsApp Web использует виртуальный скроллинг - в DOM находится только ~66 видимых элементов + небольшой буфер.

**Решение:** Постепенная прокрутка с парсингом на каждой итерации.

**Процесс:**
1. Прокручиваем в начало списка
2. Парсим начальный батч чатов
3. В цикле:
   - Прокручиваем вниз (клавиши `ArrowDown` + `PageDown` или `scrollTop`)
   - Ждем 1.5 секунды для lazy loading
   - Парсим все элементы в DOM
   - Фильтруем дубликаты по ID
   - Отправляем новые чаты
4. Останавливаемся когда:
   - Достигли конца списка (`scrollTop >= scrollHeight - clientHeight`)
   - И 10 итераций подряд не найдено новых чатов

**Методы прокрутки:**
- Клавиатура: `ArrowDown` (5 раз) + `PageDown` (1 раз)
- Программная: `chatList.scrollTop += amount`
- Fallback: `window.scrollBy(0, amount)`

### 5. Отслеживание уникальности

**Механизм:**
- Используем `Set` для хранения уже найденных ID: `seen_chat_ids`
- При каждом парсинге фильтруем: `[chat for chat in chats_batch if chat.get('id') not in seen_chat_ids]`
- Добавляем новые ID в множество

### 6. Структура данных результата

```python
{
    'id': str,              # Уникальный ID чата
    'name': str,            # Имя чата
    'type': str,            # "personal" или "group"
    'avatar': str | None,   # URL аватара или None
    'message_count': int,   # Количество непрочитанных сообщений
    'is_group': bool        # True для групп, False для личных чатов
}
```

## Проблемы и ограничения

### 1. Виртуальный скроллинг ⚠️ КРИТИЧЕСКАЯ ПРОБЛЕМА
**Проблема:** В DOM всегда только ~66 элементов, даже если чатов больше 100.

**Причина:**
- WhatsApp Web использует виртуальный скроллинг для оптимизации производительности
- В DOM хранится только видимая область + небольшой буфер (~66 элементов)
- При прокрутке старые элементы удаляются, новые добавляются
- Общее количество элементов в DOM остается примерно постоянным

**Текущее решение:** Прокрутка с парсингом на каждой итерации.

**Почему может не работать:**
- WhatsApp Web может не загружать все чаты даже при прокрутке
- Некоторые чаты могут быть скрыты или загружены асинхронно
- Скорость прокрутки может быть слишком быстрой для lazy loading
- **Возможно, WhatsApp Web ограничивает количество загружаемых чатов на клиенте**

**Наблюдения из логов:**
- Начальный парсинг: 66 чатов
- После каждой прокрутки: все еще 66 чатов в DOM
- Новые уникальные чаты не появляются
- Это означает, что либо:
  1. Прокрутка не работает должным образом
  2. WhatsApp Web не загружает новые чаты при прокрутке
  3. Все чаты уже загружены, но их действительно только 66

**Возможные решения:**
1. **Использовать CDP для перехвата сетевых запросов** - WhatsApp Web делает API запросы для загрузки чатов
2. **Попробовать более медленную прокрутку** - по одному элементу за раз
3. **Использовать IntersectionObserver** - отслеживать появление новых элементов
4. **Попробовать прокрутку через End/Home клавиши** - для быстрого перехода
5. **Исследовать внутренний state WhatsApp Web** - через `window.Store` или подобное

### 2. Селекторы могут измениться
WhatsApp Web периодически обновляет структуру DOM, что может сломать селекторы.

**Решение:** Используем несколько fallback селекторов.

### 3. Динамическая загрузка
Некоторые чаты могут загружаться асинхронно после прокрутки.

**Решение:** Увеличено время ожидания до 1.5 секунд после каждой прокрутки.

## Альтернативные подходы

### 1. Использование WhatsApp Web API через DevTools Protocol (CDP) ⭐ РЕКОМЕНДУЕТСЯ
WhatsApp Web использует внутренний API для загрузки чатов. Можно перехватить эти запросы.

**Как это работает:**
```python
# Включить перехват сетевых запросов
await page.context.tracing.start(screenshots=True, snapshots=True)

# Или использовать CDP напрямую
cdp_session = await page.context.new_cdp_session(page)
await cdp_session.send('Network.enable')

# Слушать события Network.responseReceived
# WhatsApp Web делает запросы типа:
# - /api/chat/list - список чатов
# - /api/chat/info - информация о чате
```

**Преимущества:**
- Получаем все чаты сразу, без прокрутки
- Более надежно - не зависит от DOM структуры
- Быстрее - не нужно ждать прокрутки

**Недостатки:**
- Требует знания внутреннего API WhatsApp Web
- API может измениться при обновлении WhatsApp Web

### 2. Использование внутреннего state WhatsApp Web
WhatsApp Web хранит данные в `window.Store` или подобном объекте.

**Пример:**
```javascript
// В page.evaluate()
const store = window.Store || window.WWebJS || window.webpackChunkwhatsapp_web_client;
// Получить список чатов из store
const chats = store.Chat.models || store.chats || ...
```

**Преимущества:**
- Прямой доступ к данным
- Все чаты доступны сразу

**Недостатки:**
- Структура может измениться
- Может быть защищено/обфусцировано

### 3. Использование библиотек типа whatsapp-web.js
Но это требует другого подхода (не через браузер).

### 4. Более медленная прокрутка
Уменьшить шаг прокрутки и увеличить время ожидания.

### 5. Использование MutationObserver
Отслеживать изменения DOM при прокрутке.

```javascript
const observer = new MutationObserver((mutations) => {
    // Новые элементы добавлены в DOM
    // Парсим их сразу
});
observer.observe(chatListContainer, { childList: true, subtree: true });
```

## Поток данных

### Архитектура вызовов

```
Frontend (Vue)
    ↓ GET /api/whatsapp/chats/{session_id}/stream
API Endpoint (whatsapp.py)
    ↓ stream_whatsapp_chats()
WhatsApp Service (whatsapp_service.py)
    ↓ get_chats_streaming()
Chat Parser (chat_parser.py)
    ↓ parse_chats_streaming()
    ↓ _parse_all_visible_chats()
    ↓ page.evaluate() [JavaScript в браузере]
DOM WhatsApp Web
```

### Детальный процесс парсинга

```
┌─────────────────────────────────────────────────────────────┐
│ 1. Инициализация                                            │
│    - Ждем загрузки страницы (1 сек)                        │
│    - Ищем контейнер списка чатов                            │
│    - Прокручиваем в начало                                  │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. Начальный парсинг                                        │
│    - Парсим все видимые чаты                                │
│    - Извлекаем: name, id, type, avatar, message_count       │
│    - Фильтруем дубликаты                                    │
│    - Отправляем первый батч                                 │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. Цикл прокрутки (до 200 итераций)                        │
│    ┌───────────────────────────────────────────────────┐   │
│    │ 3.1. Проверка позиции прокрутки                    │   │
│    │      - scrollTop, scrollHeight, clientHeight       │   │
│    │      - Определяем, достигли ли конца               │   │
│    └───────────────────────────────────────────────────┘   │
│                        ↓                                    │
│    ┌───────────────────────────────────────────────────┐   │
│    │ 3.2. Прокрутка                                     │   │
│    │      - ArrowDown (5 раз) + PageDown                │   │
│    │      - Или scrollTop += amount                    │   │
│    │      - Ждем 1.5 сек для lazy loading               │   │
│    └───────────────────────────────────────────────────┘   │
│                        ↓                                    │
│    ┌───────────────────────────────────────────────────┐   │
│    │ 3.3. Парсинг                                       │   │
│    │      - Ищем все элементы чатов в DOM              │   │
│    │      - Извлекаем данные каждого чата              │   │
│    │      - Фильтруем дубликаты по ID                  │   │
│    └───────────────────────────────────────────────────┘   │
│                        ↓                                    │
│    ┌───────────────────────────────────────────────────┐   │
│    │ 3.4. Отправка новых чатов                         │   │
│    │      - Если есть новые - отправляем батч          │   │
│    │      - Обновляем счетчики                         │   │
│    └───────────────────────────────────────────────────┘   │
│                        ↓                                    │
│    ┌───────────────────────────────────────────────────┐   │
│    │ 3.5. Проверка остановки                           │   │
│    │      - Достигли конца И 10 итераций без новых?   │   │
│    │      - Да → выход из цикла                        │   │
│    │      - Нет → продолжаем                           │   │
│    └───────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. Финальная проверка                                       │
│    - Прокручиваем до абсолютного конца                      │
│    - Парсим еще раз                                          │
│    - Отправляем оставшиеся чаты                             │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ 5. Завершение                                               │
│    - Отправляем событие 'complete'                          │
│    - Логируем итоговое количество                           │
└─────────────────────────────────────────────────────────────┘
```

### Формат передачи данных

**SSE (Server-Sent Events) события:**

1. **start**: `{'type': 'start', 'message': 'Loading chats...'}`
2. **chats**: `{'type': 'chats', 'chats': [<список чатов>]}`
3. **complete**: `{'type': 'complete', 'message': 'All chats loaded'}`
4. **error**: `{'type': 'error', 'error': '<текст ошибки>'}`

**Формат чата:**
```json
{
  "id": "1234567890@c.us",
  "name": "Имя чата",
  "type": "personal",
  "avatar": "https://...",
  "message_count": 5,
  "is_group": false
}
```

## Рекомендации для улучшения

1. **Добавить логирование количества элементов в DOM** на каждой итерации
2. **Проверить, действительно ли прокрутка работает** - логировать `scrollTop` и `scrollHeight`
3. **Попробовать использовать IntersectionObserver** для определения видимых элементов
4. **Исследовать внутренний API WhatsApp Web** через DevTools Protocol
5. **Увеличить время ожидания** после прокрутки до 2-3 секунд
6. **Попробовать прокрутку через клавиши End** для быстрого перехода в конец списка
7. **Использовать CDP (Chrome DevTools Protocol)** для перехвата сетевых запросов WhatsApp Web API
8. **Добавить retry механизм** для чатов, которые не загрузились с первого раза

