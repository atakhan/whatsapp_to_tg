# User Flow: Миграция чатов WhatsApp → Telegram

**Компонент:** `LandingPage.vue`  
**Тип:** Wizard-style миграция с космической тематикой

---

## 🎬 Полный User Flow

### 📍 **Этап 0: Начальное состояние (Landing)**

```
┌─────────────────────────────────────┐
│  Звездное небо (StarsBackground)    │
│  ┌──────────┐      ┌──────────┐    │
│  │ WhatsApp │      │ Telegram │    │
│  │  Планета │      │  Планета │    │
│  └──────────┘      └──────────┘    │
│        🚀 Ракета                    │
│  [Запустить перенос]                │
└─────────────────────────────────────┘
```

**Состояние:**
- Две планеты (WhatsApp и Telegram) в split-screen
- Ракета парит над WhatsApp планетой
- Кнопка "Запустить перенос" внизу
- Заголовок "Миграция чатов" и badge "TETRAKOM"

**Действия пользователя:**
- Клик на кнопку "Запустить перенос" ИЛИ клик мышью (любой левый клик)

---

### 📍 **Этап 1: Запуск миграции (startMigration)**

```
Анимация скрытия элементов (hideStage 0→6):
1. Кнопка "Запустить перенос" исчезает
2. Badge "TETRAKOM" исчезает
3. Заголовок "Миграция чатов" исчезает
4. Описание исчезает
5. Ракета исчезает
6. Telegram планета исчезает/уменьшается

→ WhatsApp планета центрируется и увеличивается
```

**Состояние:**
- `migrationStarted = true`
- `hideStage` постепенно увеличивается (0→6)
- `whatsappCentered = true`
- WhatsApp планета становится большой в центре экрана

---

### 📍 **Этап 2: Подключение к WhatsApp**

```
┌─────────────────────────────────────┐
│                                     │
│      ┌──────────────────┐           │
│      │  WhatsApp        │           │
│      │  [Подключиться]  │           │
│      └──────────────────┘           │
│                                     │
└─────────────────────────────────────┘
```

**Вариант A: Автоматическое подключение (startMigration)**
- После центрирования планеты показывается overlay
- Автоматически вызывается `startWhatsAppConnection()`

**Вариант B: Ручное подключение (onWhatsAppPlanetClick)**
- Пользователь кликает на планету
- Вызывается `startWhatsAppAuth()`

**Процесс подключения:**

1. **Проверка сессий** (`startWhatsAppConnection`)
   - Проверяет существующие сессии
   - Пытается переиспользовать активную сессию
   - Если сессия валидна → сразу переходит к загрузке чатов

2. **Создание новой сессии**
   - Создает новую сессию
   - Получает QR-код (если нужен)
   - Показывает QR-код в overlay

3. **Ожидание сканирования QR**
   - Пользователь сканирует QR-код в WhatsApp
   - Статус меняется: `loading` → `qr` → `connecting` → `connected`
   - Опрос статуса через `startStatusPolling()`

4. **Успешное подключение** (`onWhatsAppConnected`)
   - Показывается сообщение "Подключено!"
   - Планета уменьшается (`whatsappShrunk = true`)
   - Начинается загрузка чатов

**Состояния:**
- `waStatus`: 'idle' → 'loading' → 'qr' → 'connecting' → 'connected'
- `showWaOverlay = true` (показывается overlay)
- `whatsappShrunk = true` (планета уменьшается)

---

### 📍 **Этап 3: Выбор WhatsApp чата**

```
┌─────────────────────────────────────┐
│  [Какой чат перенести?]             │
│  [Поиск чата...]                    │
│                                     │
│        ⚪ WhatsApp планета          │
│     ⭕  ⭕  ⭕  ⭕  ⭕              │
│    ⭕        ⭕        ⭕          │
│     ⭕  ⭕  ⭕  ⭕  ⭕              │
│        (чаты в орбите)              │
└─────────────────────────────────────┘
```

**Процесс:**

1. **Загрузка чатов** (`loadChats`)
   - SSE стриминг чатов через EventSource
   - Чаты появляются по одному с анимацией
   - Позиционируются в орбитальных кольцах вокруг планеты

2. **Поиск чата** (опционально)
   - Пользователь может ввести поисковый запрос
   - Фильтрация с поддержкой транслитерации (RU↔EN)
   - Fuzzy matching для опечаток

3. **Выбор чата** (`selectChat`)
   - Клик на чат → выделение
   - Повторный клик → снятие выделения
   - Выбранный чат увеличивается, остальные затемняются

4. **Продолжение** (`proceedWithSelectedChat`)
   - Клик на кнопку "Перенести в телеграм"
   - Выбранный чат перемещается в левый верхний угол
   - WhatsApp планета также перемещается в угол
   - Остальные чаты скрываются

**Состояния:**
- `chatsLoading = true` → `false`
- `visibleChats` - отфильтрованные чаты
- `selectedChat` - выбранный чат
- `chatMovingToCorner = true` - анимация перемещения

---

### 📍 **Этап 4: Просмотр сообщений**

```
┌─────────────────────────────────────┐
│  ⚪ WhatsApp (в углу)              │
│                                     │
│  ┌─────────────────────────────┐   │
│  │ Загруженные сообщения       │   │
│  │ ┌─────────────────────────┐ │   │
│  │ │ Сообщение 1             │ │   │
│  │ │ Сообщение 2             │ │   │
│  │ │ ...                     │ │   │
│  │ └─────────────────────────┘ │   │
│  │ [Назад] [Продолжить]        │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

**Процесс:**

1. **Загрузка сообщений** (`loadAndShowMessages`)
   - SSE стриминг последних N сообщений
   - Показывается прогресс загрузки
   - Сообщения появляются в списке

2. **Просмотр сообщений**
   - Пользователь видит список сообщений
   - Может прокручивать список
   - Видит типы сообщений (текст, медиа, и т.д.)

3. **Продолжение** (`proceedToTelegramAuth`)
   - Клик на "Продолжить"
   - Скрывается список сообщений
   - Начинается авторизация Telegram

**Состояния:**
- `showMessages = true`
- `messagesLoading = true` → `false`
- `messages` - загруженные сообщения

---

### 📍 **Этап 5: Авторизация Telegram**

```
┌─────────────────────────────────────┐
│                                     │
│      ┌──────────────────┐           │
│      │  Telegram        │           │
│      │  [Авторизоваться]│           │
│      └──────────────────┘           │
│                                     │
└─────────────────────────────────────┘
```

**Процесс:**

1. **Инициация авторизации** (`proceedToTelegramAuth`)
   - Telegram планета центрируется
   - Показывается overlay с кнопкой "Авторизоваться"

2. **Ввод телефона** (`startTelegramAuth` → `sendTelegramCode`)
   - Пользователь вводит номер телефона
   - Отправляется запрос на получение кода
   - Переход к вводу кода

3. **Ввод кода** (`verifyTelegramCode`)
   - Пользователь вводит код из Telegram
   - Проверка кода
   - Если нужен 2FA → переход к вводу пароля

4. **Ввод пароля 2FA** (опционально, `verifyTelegramPassword`)
   - Если включен 2FA, запрашивается пароль
   - Проверка пароля

5. **Успешная авторизация** (`onTelegramConnected`)
   - Показывается сообщение "Авторизовано!"
   - Планета уменьшается
   - Показывается панель выбора назначения

**Состояния:**
- `tgPhase`: 'hidden' → 'phone' → 'code' → 'password' (опционально) → 'connected'
- `telegramCentered = true`
- `telegramShrunk = true`

---

### 📍 **Этап 6: Выбор Telegram чата**

```
┌─────────────────────────────────────┐
│  Выбранный чат из вастапп:          │
│  ⭕ Название чата                   │
│                                     │
│  Куда перенести ватсап-чат?         │
│                                     │
│        ⚪ Telegram планета          │
│     ⭕  ⭕  ⭕  ⭕  ⭕              │
│    ⭕        ⭕        ⭕          │
│     ⭕  ⭕  ⭕  ⭕  ⭕              │
│        (Telegram чаты)              │
│                                     │
│  [Начать перенос]                   │
└─────────────────────────────────────┘
```

**Процесс:**

1. **Загрузка Telegram чатов** (`loadTelegramChats`)
   - Запрос списка контактов/чатов Telegram
   - Чаты появляются в орбитальных кольцах

2. **Выбор Telegram чата** (`selectTelegramChat`)
   - Клик на Telegram чат
   - Выделение выбранного чата
   - Кнопка "Начать перенос" становится активной

3. **Запуск миграции** (`startDataMigration`)
   - Клик на "Начать перенос"
   - Начинается процесс миграции данных

**Состояния:**
- `showDestinationSelection = true`
- `telegramChatsLoading = true` → `false`
- `visibleTelegramChats` - Telegram чаты
- `selectedTelegramChat` - выбранный Telegram чат
- `canStartMigration = true` (когда выбран чат)

---

### 📍 **Этап 7: Миграция данных** (TODO)

```
┌─────────────────────────────────────┐
│  Миграция в процессе...             │
│  [Прогресс бар]                     │
│  Сообщения переносятся...           │
└─────────────────────────────────────┘
```

**Статус:** Реализация в процессе (`startDataMigration`)

---

## 🔄 Альтернативные пути (Edge Cases)

### Восстановление сессий (onMounted)

**WhatsApp:**
- При загрузке страницы проверяется сохраненная сессия
- Если сессия валидна → автоматически подключается
- Пропускаются этапы 1-2, сразу переход к этапу 3

**Telegram:**
- Проверяется сохраненный user_id
- Если сессия валидна → автоматически авторизуется
- Пропускается этап 5

---

### Возврат назад

1. **Из просмотра сообщений** (`goBackToChatSelection`)
   - Возврат к выбору WhatsApp чата
   - WhatsApp планета возвращается в центр
   - Чаты снова видны

2. **Из выбора Telegram чата** (`goBackToWhatsAppChats`)
   - Возврат к выбору WhatsApp чата
   - Telegram планета скрывается
   - WhatsApp планета возвращается в центр

---

### Ошибки

1. **Ошибка подключения WhatsApp**
   - Показывается сообщение об ошибке
   - Кнопка "Попробовать снова" (`retryConnection`)

2. **Ошибка загрузки чатов**
   - Показывается сообщение об ошибке
   - Возможность повторить

3. **Ошибка авторизации Telegram**
   - Показывается сообщение об ошибке
   - Возможность повторить ввод

---

## 📊 Визуальная схема flow

```
[Landing]
    ↓
[Запустить перенос]
    ↓
[Анимация скрытия]
    ↓
[WhatsApp планета центрируется]
    ↓
[Подключение WhatsApp]
    ├─→ [QR код] → [Сканирование] → [Подключено]
    └─→ [Переиспользование сессии] → [Подключено]
    ↓
[WhatsApp планета уменьшается]
    ↓
[Загрузка WhatsApp чатов]
    ↓
[Поиск чата] (опционально)
    ↓
[Выбор WhatsApp чата]
    ↓
[Перемещение в угол]
    ↓
[Загрузка сообщений]
    ↓
[Просмотр сообщений]
    ↓
[Продолжить]
    ↓
[Telegram планета центрируется]
    ↓
[Авторизация Telegram]
    ├─→ [Ввод телефона]
    ├─→ [Ввод кода]
    └─→ [Ввод пароля 2FA] (опционально)
    ↓
[Telegram планета уменьшается]
    ↓
[Загрузка Telegram чатов]
    ↓
[Выбор Telegram чата]
    ↓
[Начать перенос]
    ↓
[Миграция данных] (TODO)
```

---

## 🎯 Ключевые особенности UX

1. **Космическая тематика**
   - Планеты, орбиты, ракета
   - Анимации перемещения и трансформации

2. **Визуальная обратная связь**
   - Пульсация при загрузке
   - Анимации появления элементов
   - Изменение размеров и позиций

3. **Прогрессивное раскрытие**
   - Элементы появляются по мере необходимости
   - Скрытие ненужных элементов

4. **Возможность возврата**
   - Кнопки "Назад" на каждом этапе
   - Сохранение состояния

5. **Обработка ошибок**
   - Понятные сообщения об ошибках
   - Возможность повторить действие

---

## 🔍 Состояния компонента

### Основные состояния по этапам:

| Этап | migrationStarted | whatsappCentered | whatsappShrunk | telegramCentered | telegramShrunk |
|------|------------------|------------------|----------------|------------------|----------------|
| Landing | false | false | false | false | false |
| После запуска | true | true | false | false | false |
| WhatsApp подключен | true | true | true | false | false |
| Выбор WhatsApp чата | true | true | true | false | false |
| Просмотр сообщений | true | true | true* | false | false |
| Telegram авторизация | true | true | true* | true | false |
| Telegram подключен | true | true | true* | true | true |
| Выбор Telegram чата | true | true | true* | true | true |

*`whatsappInCorner = true` когда показываются сообщения

---

*Документ создан на основе анализа LandingPage.vue*

